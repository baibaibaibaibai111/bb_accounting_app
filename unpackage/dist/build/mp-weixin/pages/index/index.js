"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/storage.js"),n={data:()=>({currentTab:"list",weekdays:["日","一","二","三","四","五","六"],currentYear:(new Date).getFullYear(),currentMonth:(new Date).getMonth(),calendarDays:[],balance:{total:0,alipay:0,wechat:0},editBalance:{alipay:0,wechat:0},monthlyStats:{income:0,expense:0,balance:0},records:[],groupedRecords:{},totalRecords:0,options:[{text:"删除",style:{backgroundColor:"#ff3b30"}}]}),methods:{loadRecords(){this.records=t.getRecords(),console.log("原始记录：",this.records),this.groupedRecords={},this.records.forEach((e=>{const t=e.date.split(" ")[0];this.groupedRecords[t]||(this.groupedRecords[t]=[]),this.groupedRecords[t].push(e)})),this.totalRecords=this.records.length,console.log("分组后的记录：",this.groupedRecords);const e=new Date,n=e.getMonth(),a=e.getFullYear();this.monthlyStats.income=0,this.monthlyStats.expense=0,this.records.forEach((e=>{const t=new Date(e.date);t.getMonth()===n&&t.getFullYear()===a&&("income"===e.type?this.monthlyStats.income+=Number(e.amount):this.monthlyStats.expense+=Number(e.amount))})),this.monthlyStats.balance=this.monthlyStats.income-this.monthlyStats.expense,this.generateCalendar()},loadBalance(){const e=t.getBalance();this.balance=e;const n=Number(e.alipay),a=Number(e.wechat),o=Number(this.monthlyStats.income),r=Number(this.monthlyStats.expense);this.balance.total=n+a+o-r},deleteRecord(n,a){e.index.showModal({title:"提示",content:"确定要删除该记录吗？",success:n=>{n.confirm&&(this.records.splice(a,1),t.saveRecords(this.records),this.loadRecords(),e.index.showToast({title:"删除成功",icon:"success"}))}})},showBalanceEdit(){this.editBalance={...this.balance},this.$refs.balancePopup.open()},cancelEdit(){this.$refs.balancePopup.close()},saveBalance(){t.saveBalance(this.editBalance)?(this.loadBalance(),this.$refs.balancePopup.close(),e.index.showToast({title:"保存成功",icon:"success"})):e.index.showToast({title:"保存失败",icon:"error"})},isToday(e){if(!e.isCurrentMonth)return!1;const t=new Date;return t.getFullYear()===this.currentYear&&t.getMonth()===this.currentMonth&&t.getDate()===e.day},generateCalendar(){const e=[],t=new Date(this.currentYear,this.currentMonth,1),n=new Date(this.currentYear,this.currentMonth+1,0),a=t.getDay(),o=n.getDate();for(let s=a-1;s>=0;s--){const t=new Date(this.currentYear,this.currentMonth,-s);e.push({day:t.getDate(),isCurrentMonth:!1,hasRecord:!1})}for(let s=1;s<=o;s++){const t=new Date(this.currentYear,this.currentMonth,s),n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,a=this.records.filter((e=>e.date.startsWith(n)));e.push({day:s,isCurrentMonth:!0,hasRecord:a.length>0,income:a.filter((e=>"income"===e.type)).reduce(((e,t)=>e+Number(t.amount)),0),expense:a.filter((e=>"expense"===e.type)).reduce(((e,t)=>e+Number(t.amount)),0)})}const r=42-e.length;for(let s=1;s<=r;s++){const t=new Date(this.currentYear,this.currentMonth+1,s);e.push({day:t.getDate(),isCurrentMonth:!1,hasRecord:!1})}this.calendarDays=e},showDayRecords(t){if(!t.hasRecord)return;const n=new Date(this.currentYear,this.currentMonth,t.day),a=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`;this.records.filter((e=>e.date.startsWith(a))),e.index.showModal({title:`${this.currentMonth+1}月${t.day}日收支`,content:`收入：+${t.income}\n支出：-${t.expense}`,showCancel:!1})},prevMonth(){0===this.currentMonth?(this.currentYear--,this.currentMonth=11):this.currentMonth--,this.generateCalendar()},nextMonth(){11===this.currentMonth?(this.currentYear++,this.currentMonth=0):this.currentMonth++,this.generateCalendar()}},watch:{currentMonth(){this.generateCalendar()}},onLoad(){this.loadBalance(),this.loadRecords()},onShow(){this.loadBalance(),this.loadRecords()}};if(!Array){(e.resolveComponent("uni-swipe-action-item")+e.resolveComponent("uni-swipe-action")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-swipe-action-item/uni-swipe-action-item.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-swipe-action/uni-swipe-action.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js"))();const a=e._export_sfc(n,[["render",function(t,n,a,o,r,s){return e.e({a:"list"===r.currentTab},(r.currentTab,{}),{b:"list"===r.currentTab?1:"",c:e.o((e=>r.currentTab="list")),d:"calendar"===r.currentTab},(r.currentTab,{}),{e:"calendar"===r.currentTab?1:"",f:e.o((e=>r.currentTab="calendar")),g:"list"===r.currentTab},"list"===r.currentTab?{h:e.o(((...e)=>s.showBalanceEdit&&s.showBalanceEdit(...e))),i:e.t(r.balance.total),j:e.t(r.balance.alipay),k:e.t(r.balance.wechat),l:e.t(r.monthlyStats.income),m:e.t(r.monthlyStats.expense),n:e.t(r.monthlyStats.balance>=0?"+":""),o:e.t(r.monthlyStats.balance),p:e.n(r.monthlyStats.balance>=0?"income":"expense")}:{q:e.o(((...e)=>s.prevMonth&&s.prevMonth(...e))),r:e.t(r.currentYear),s:e.t(r.currentMonth+1),t:e.o(((...e)=>s.nextMonth&&s.nextMonth(...e))),v:e.f(r.weekdays,((t,n,a)=>({a:e.t(t),b:t}))),w:e.f(r.calendarDays,((t,n,a)=>e.e({a:e.t(t.day),b:t.hasRecord},t.hasRecord?e.e({c:t.income>0},t.income>0?{d:e.t(t.income)}:{},{e:t.expense>0},t.expense>0?{f:e.t(t.expense)}:{}):{},{g:n,h:t.isCurrentMonth?"":1,i:t.hasRecord?1:"",j:s.isToday(t)?1:"",k:e.o((e=>s.showDayRecords(t)),n)})))},{x:e.t(r.totalRecords),y:e.f(r.groupedRecords,((t,n,a)=>({a:e.t(n),b:e.f(t,((t,n,o)=>({a:e.t(t.category),b:e.t(t.date.split(" ")[1]),c:e.t("income"===t.type?"+":"-"),d:e.t(t.amount),e:e.n("income"===t.type?"income":"expense"),f:n,g:e.o((e=>s.deleteRecord(t,n)),n),h:"9fedd96c-1-"+a+"-"+o+",9fedd96c-0"}))),c:n}))),z:e.p({"right-options":r.options}),A:e.o(((...e)=>s.cancelEdit&&s.cancelEdit(...e))),B:r.editBalance.alipay,C:e.o((e=>r.editBalance.alipay=e.detail.value)),D:r.editBalance.wechat,E:e.o((e=>r.editBalance.wechat=e.detail.value)),F:e.o(((...e)=>s.cancelEdit&&s.cancelEdit(...e))),G:e.o(((...e)=>s.saveBalance&&s.saveBalance(...e))),H:e.sr("balancePopup","9fedd96c-2"),I:e.p({type:"center"})})}]]);wx.createPage(a);
